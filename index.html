<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protótipo - Ferramenta Certa</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .screen {
            transition: opacity 0.3s ease-in-out;
        }
        .menu-item, .nav-btn, .filter-btn {
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out, transform 0.1s ease-in-out;
        }
        .nav-btn:active, .filter-btn:active {
            transform: scale(0.95);
        }
        .img-container img {
            object-fit: contain; /* Garante que a imagem inteira seja visível */
            width: 100%;
            height: 100%;
        }
        .filter-btn-active {
            background-color: #2563eb; /* bg-blue-600 */
            color: white;
        }
        #chat-conversation-container {
            scroll-behavior: smooth;
        }
        /* Spinner de Carregamento */
        .loader-overlay {
            background-color: rgba(255, 255, 255, 0.8);
        }
        .loader {
            border-top-color: #3b82f6;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @-webkit-keyframes spin {
            to { -webkit-transform: rotate(360deg); }
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <!-- Container do tamanho de um celular -->
    <div class="w-full max-w-sm h-[800px] max-h-[90vh] bg-white shadow-2xl rounded-2xl overflow-hidden flex flex-col relative">

        <!-- Overlay de Carregamento -->
        <div id="loader-overlay" class="hidden absolute inset-0 z-50 flex justify-center items-center loader-overlay">
            <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-24 w-24"></div>
        </div>

        <!-- Alerta Customizado (Modal) -->
        <div id="custom-alert" role="alert" class="hidden absolute top-5 left-1/2 -translate-x-1/2 bg-red-500 text-white text-sm font-semibold py-2 px-4 rounded-lg shadow-lg z-50 transition-transform duration-300 transform">
            <p id="custom-alert-message"></p>
        </div>
        
        <!-- Modais de Confirmação -->
        <div id="modal-overlay" class="hidden absolute inset-0 bg-black bg-opacity-50 z-40 flex justify-center items-center p-4">
            <!-- Confirmação de Exclusão -->
            <div id="confirm-delete-modal" class="hidden bg-white p-6 rounded-lg shadow-xl text-center w-full">
                <h3 class="text-lg font-bold text-gray-900">Confirmar Exclusão</h3>
                <p class="text-gray-600 my-4">Tem certeza que deseja excluir esta ferramenta? Esta ação não pode ser desfeita.</p>
                <div class="flex justify-center gap-4">
                    <button onclick="closeModal()" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg font-semibold">Cancelar</button>
                    <button id="confirm-delete-button" class="px-6 py-2 bg-red-600 text-white rounded-lg font-semibold">Excluir</button>
                </div>
            </div>
            <!-- Confirmação de Agendamento -->
             <div id="confirm-schedule-modal" class="hidden bg-white p-6 rounded-lg shadow-xl text-center w-full">
                <h3 class="text-lg font-bold text-gray-900">Agendamento</h3>
                <p class="text-gray-600 my-4">Você será notificado assim que esta ferramenta estiver disponível. Deseja confirmar?</p>
                <div class="flex justify-center gap-4">
                    <button onclick="closeModal()" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg font-semibold">Cancelar</button>
                    <button onclick="confirmSchedule()" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-semibold">Confirmar</button>
                </div>
            </div>
        </div>


        <!-- ===== TELA: Login ===== -->
        <div id="screen-login" class="screen flex flex-col h-full p-8 justify-center items-center text-center">
            <div class="bg-blue-600 p-4 rounded-full mb-6">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" /></svg>
            </div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Ferramenta Certa</h1>
            <p class="text-gray-500 mb-8">Empreste ferramentas. Conecte-se com vizinhos.</p>
            <div class="w-full">
                <input id="login-email" type="email" placeholder="E-mail" class="w-full p-3 mb-4 bg-gray-100 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input id="login-password" type="password" placeholder="Senha" class="w-full p-3 mb-6 bg-gray-100 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button onclick="showScreen('screen-dashboard')" class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors">Entrar</button>
                <p class="text-gray-500 text-sm mt-4">Não tem uma conta? <a href="javascript:void(0)" onclick="showScreen('screen-register')" class="text-blue-600 font-semibold">Cadastre-se</a></p>
            </div>
        </div>

        <!-- ===== TELA: Cadastro ===== -->
        <div id="screen-register" class="screen hidden flex-col h-full p-8 justify-center">
            <h1 class="text-2xl font-bold text-gray-800 mb-6 text-center">Crie sua Conta</h1>
            <form id="register-form" class="w-full" onsubmit="registerUser(event)">
                <input id="register-name" type="text" placeholder="Nome completo" required class="w-full p-3 mb-4 bg-gray-100 rounded-lg border focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input id="register-email" type="email" placeholder="E-mail" required class="w-full p-3 mb-4 bg-gray-100 rounded-lg border focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input id="register-password" type="password" placeholder="Senha" required class="w-full p-3 mb-4 bg-gray-100 rounded-lg border focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input id="register-confirm-password" type="password" placeholder="Confirmar Senha" required class="w-full p-3 mb-6 bg-gray-100 rounded-lg border focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button type="submit" class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors">Cadastrar</button>
                <p class="text-gray-500 text-sm mt-4 text-center">Já tem uma conta? <a href="javascript:void(0)" onclick="showScreen('screen-login')" class="text-blue-600 font-semibold">Faça Login</a></p>
            </form>
        </div>


        <!-- ===== TELA: Principal (Dashboard) ===== -->
        <div id="screen-dashboard" class="screen hidden flex-col h-full">
            <header class="p-4 border-b">
                <h1 class="text-xl font-bold text-gray-800">Início</h1>
                <div class="relative mt-4">
                    <input type="text" id="search-input" placeholder="Buscar furadeira, escada..." class="w-full p-3 pl-10 bg-gray-100 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                </div>
            </header>
            <main class="flex-grow p-4 overflow-y-auto">
                <h2 class="text-lg font-semibold text-gray-700 mb-3">Filtros</h2>
                <div class="flex gap-2 mb-4">
                    <button id="filter-all" onclick="applyFilter('all')" class="filter-btn flex-1 py-2 px-4 text-sm font-semibold rounded-lg transition-colors filter-btn-active">Todos</button>
                    <button id="filter-available" onclick="applyFilter('available')" class="filter-btn flex-1 py-2 px-4 text-sm font-semibold bg-gray-200 text-gray-700 rounded-lg transition-colors">Disponíveis</button>
                    <button id="filter-in-use" onclick="applyFilter('in-use')" class="filter-btn flex-1 py-2 px-4 text-sm font-semibold bg-gray-200 text-gray-700 rounded-lg transition-colors">Em uso</button>
                </div>
                <div id="tool-list" class="grid grid-cols-2 gap-4"></div>
            </main>
            <nav class="main-nav border-t bg-white">
                <div class="flex justify-around p-2">
                    <button data-screen="screen-dashboard" onclick="showScreen('screen-dashboard')" class="nav-btn flex flex-col items-center text-blue-600 w-1/3" aria-label="Início">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg>
                        <span class="text-xs font-medium">Início</span>
                    </button>
                     <button data-screen="screen-chat-list" onclick="showScreen('screen-chat-list')" class="nav-btn flex flex-col items-center text-gray-500 w-1/3 hover:text-blue-600" aria-label="Chat">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.083-3.083A7.002 7.002 0 012 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM4.417 11.583A5.002 5.002 0 0010 15a5 5 0 005-5c0-2.761-2.686-5-6-5s-6 2.239-6 5c0 1.288.592 2.436 1.583 3.25z" clip-rule="evenodd" /></svg>
                        <span class="text-xs font-medium">Chat</span>
                    </button>
                    <button data-screen="screen-profile" onclick="showScreen('screen-profile')" class="nav-btn relative flex flex-col items-center text-gray-500 w-1/3 hover:text-blue-600" aria-label="Perfil">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0012 11z" clip-rule="evenodd" /></svg>
                        <span id="profile-notification-badge" class="hidden absolute top-0 right-1/4 w-2 h-2 bg-red-500 rounded-full"></span>
                        <span class="text-xs font-medium">Perfil</span>
                    </button>
                </div>
            </nav>
        </div>
        
        <!-- ===== TELA: Detalhes da Ferramenta ===== -->
        <div id="screen-details" class="screen hidden flex-col h-full">
            <header class="p-4 border-b flex items-center">
                <button onclick="showScreen('screen-dashboard')" class="text-gray-600 mr-4" aria-label="Voltar para Início"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                <h1 class="text-xl font-bold text-gray-800">Detalhes</h1>
            </header>
            <main class="flex-grow overflow-y-auto">
                <div class="w-full h-48 bg-gray-100 img-container"><img id="details-image" src="" alt="Foto da Ferramenta"></div>
                <div class="p-4">
                    <h2 id="details-title" class="text-2xl font-bold text-gray-800 mb-1"></h2>
                    <p id="details-owner" class="text-gray-600 font-medium mb-4"></p>
                    <p id="details-description" class="text-gray-700 mb-6"></p>
                    <div id="details-status-box" class="flex items-center space-x-4 bg-gray-100 p-3 rounded-lg"></div>
                </div>
            </main>
            <footer class="p-4 border-t bg-white">
                <button id="details-action-button" class="w-full text-white p-4 rounded-lg font-semibold transition-colors text-lg"></button>
            </footer>
        </div>

        <!-- ===== TELA: Solicitar Empréstimo ===== -->
        <div id="screen-request-loan" class="screen hidden flex-col h-full">
            <header class="p-4 border-b flex items-center">
                <button id="request-back-button" class="text-gray-600 mr-4" aria-label="Voltar para Detalhes"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                <h1 class="text-xl font-bold text-gray-800">Solicitar Empréstimo</h1>
            </header>
            <main class="flex-grow p-6 overflow-y-auto">
                <div class="mb-6 text-center">
                    <div class="w-24 h-24 mx-auto rounded-lg bg-gray-100 img-container"><img id="request-tool-image" class="rounded-lg" alt="Imagem da ferramenta a ser solicitada"></div>
                    <h2 id="request-tool-name" class="text-xl font-bold mt-4"></h2>
                    <p id="request-tool-owner" class="text-gray-500"></p>
                </div>
                 <form id="loan-request-form" onsubmit="submitLoanRequest(event)">
                    <div class="mb-4">
                        <label for="request-start-date" class="block text-sm font-medium text-gray-700">Data de Retirada</label>
                        <input type="date" id="request-start-date" required class="mt-1 block w-full p-3 bg-gray-100 rounded-lg border focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="mb-4">
                        <label for="request-end-date" class="block text-sm font-medium text-gray-700">Data de Devolução</label>
                        <input type="date" id="request-end-date" required class="mt-1 block w-full p-3 bg-gray-100 rounded-lg border focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </form>
            </main>
            <footer class="p-4 border-t bg-white">
                <button id="request-submit-button" class="w-full bg-blue-600 text-white p-4 rounded-lg font-semibold hover:bg-blue-700 transition-colors text-lg">Enviar Solicitação</button>
            </footer>
        </div>

        <!-- ===== TELA: Perfil ===== -->
        <div id="screen-profile" class="screen hidden flex-col h-full">
            <header class="p-6 bg-blue-600 text-white text-center relative">
                 <img src="https://placehold.co/80x80/ffffff/3b82f6?text=EU" alt="Avatar do usuário" class="w-20 h-20 rounded-full mx-auto mb-2 border-4 border-white">
                 <h1 id="profile-name-header" class="text-2xl font-bold">Meu Perfil</h1>
                 <p class="text-blue-200">membro desde 2024</p>
                 <button onclick="showScreen('screen-edit-profile')" class="absolute top-4 right-4 text-white p-2 rounded-full hover:bg-blue-700" aria-label="Editar Perfil">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.096 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                 </button>
            </header>
            <main class="flex-grow overflow-y-auto" onclick="closeAllMenus()">
                <div class="border-b border-gray-200">
                    <nav class="flex -mb-px">
                        <a href="javascript:void(0)" id="tab-my-tools" onclick="showProfileTab('my-tools')" class="w-1/3 py-4 px-1 text-center border-b-2 font-medium">Minhas Ferramentas</a>
                        <a href="javascript:void(0)" id="tab-my-loans" onclick="showProfileTab('my-loans')" class="w-1/3 py-4 px-1 text-center border-b-2 font-medium">Meus Empréstimos</a>
                        <a href="javascript:void(0)" id="tab-my-requests" onclick="showProfileTab('my-requests')" class="w-1/3 py-4 px-1 text-center border-b-2 font-medium relative">
                            Solicitações 
                            <span id="requests-notification-badge" class="hidden absolute top-3 ml-1 w-2 h-2 bg-red-500 rounded-full"></span>
                        </a>
                    </nav>
                </div>
                <div id="tab-content-my-tools" class="p-4"></div>
                <div id="tab-content-my-loans" class="p-4 hidden"></div>
                <div id="tab-content-my-requests" class="p-4 hidden"></div>
                <button onclick="prepareAddTool()" class="absolute bottom-24 right-6 bg-blue-600 text-white p-4 rounded-full shadow-lg hover:bg-blue-700 transition-colors" aria-label="Adicionar nova ferramenta"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg></button>
            </main>
            <nav class="main-nav border-t bg-white">
                <div class="flex justify-around p-2">
                    <button data-screen="screen-dashboard" onclick="showScreen('screen-dashboard')" class="nav-btn flex flex-col items-center text-gray-500 w-1/3 hover:text-blue-600" aria-label="Início"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg><span class="text-xs font-medium">Início</span></button>
                    <button data-screen="screen-chat-list" onclick="showScreen('screen-chat-list')" class="nav-btn flex flex-col items-center text-gray-500 w-1/3 hover:text-blue-600" aria-label="Chat"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.083-3.083A7.002 7.002 0 012 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM4.417 11.583A5.002 5.002 0 0010 15a5 5 0 005-5c0-2.761-2.686-5-6-5s-6 2.239-6 5c0 1.288.592 2.436 1.583 3.25z" clip-rule="evenodd" /></svg><span class="text-xs font-medium">Chat</span></button>
                    <button data-screen="screen-profile" onclick="showScreen('screen-profile')" class="nav-btn flex flex-col items-center text-blue-600 w-1/3" aria-label="Perfil"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg><span class="text-xs font-medium">Perfil</span></button>
                </div>
            </nav>
        </div>
        
        <!-- ===== TELA: Lista de Chats ===== -->
        <div id="screen-chat-list" class="screen hidden flex-col h-full">
            <header class="p-4 border-b">
                <h1 class="text-xl font-bold text-gray-800">Conversas</h1>
            </header>
            <main id="chat-list-container" class="flex-grow overflow-y-auto"></main>
             <nav class="main-nav border-t bg-white">
                <div class="flex justify-around p-2">
                    <button data-screen="screen-dashboard" onclick="showScreen('screen-dashboard')" class="nav-btn flex flex-col items-center text-gray-500 w-1/3 hover:text-blue-600" aria-label="Início"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg><span class="text-xs font-medium">Início</span></button>
                    <button data-screen="screen-chat-list" onclick="showScreen('screen-chat-list')" class="nav-btn flex flex-col items-center text-blue-600 w-1/3" aria-label="Chat"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.083-3.083A7.002 7.002 0 012 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM4.417 11.583A5.002 5.002 0 0010 15a5 5 0 005-5c0-2.761-2.686-5-6-5s-6 2.239-6 5c0 1.288.592 2.436 1.583 3.25z" clip-rule="evenodd" /></svg><span class="text-xs font-medium">Chat</span></button>
                    <button data-screen="screen-profile" onclick="showScreen('screen-profile')" class="nav-btn relative flex flex-col items-center text-gray-500 w-1/3 hover:text-blue-600" aria-label="Perfil"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0012 11z" clip-rule="evenodd" /></svg><span id="profile-notification-badge-chat" class="hidden absolute top-0 right-1/4 w-2 h-2 bg-red-500 rounded-full"></span><span class="text-xs font-medium">Perfil</span></button>
                </div>
            </nav>
        </div>
        
        <!-- ===== TELA: Conversa do Chat ===== -->
        <div id="screen-chat-conversation" class="screen hidden flex-col h-full">
            <header class="p-4 border-b flex items-center bg-white shadow-sm">
                <button onclick="showScreen('screen-chat-list')" class="text-gray-600 mr-4" aria-label="Voltar para lista de chats"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                <img id="conversation-user-avatar" src="" alt="Avatar do usuário da conversa" class="w-10 h-10 rounded-full mr-3">
                <div>
                    <h1 id="conversation-user-name" class="text-lg font-bold text-gray-800"></h1>
                    <p id="conversation-tool-context" class="text-sm text-gray-500"></p>
                </div>
            </header>
            <main id="chat-conversation-container" class="flex-grow p-4 overflow-y-auto bg-gray-50 flex flex-col space-y-4"></main>
            <footer class="p-2 border-t bg-white">
                <div class="flex items-center p-2">
                    <input id="chat-message-input" type="text" placeholder="Digite sua mensagem..." class="w-full p-3 bg-gray-100 rounded-full border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="send-message-button" class="ml-2 bg-blue-600 text-white p-3 rounded-full flex-shrink-0" aria-label="Enviar mensagem">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>
                    </button>
                </div>
            </footer>
        </div>


         <!-- ===== TELA: Editar Perfil ===== -->
        <div id="screen-edit-profile" class="screen hidden flex-col h-full">
            <header class="p-4 border-b flex items-center">
                <button onclick="showScreen('screen-profile')" class="text-gray-600 mr-4" aria-label="Voltar para o perfil"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                <h1 class="text-xl font-bold text-gray-800">Editar Perfil</h1>
            </header>
            <main class="flex-grow p-6 overflow-y-auto">
                <div class="mb-4"><label for="profile-name" class="block text-sm font-medium text-gray-700">Nome Completo</label><input type="text" id="profile-name" class="mt-1 block w-full p-3 bg-gray-100 rounded-lg border focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
                 <div class="mb-4"><label for="profile-address" class="block text-sm font-medium text-gray-700">Endereço (Bairro)</label><input type="text" id="profile-address" class="mt-1 block w-full p-3 bg-gray-100 rounded-lg border focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
                 <div class="mb-4"><label for="profile-phone" class="block text-sm font-medium text-gray-700">Telefone</label><input type="tel" id="profile-phone" class="mt-1 block w-full p-3 bg-gray-100 rounded-lg border focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
                <div class="mb-4"><label for="profile-email" class="block text-sm font-medium text-gray-700">Email</label><input type="email" id="profile-email" class="mt-1 block w-full p-3 bg-gray-100 rounded-lg border focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
                <div class="mb-4"><label for="profile-dob" class="block text-sm font-medium text-gray-700">Data de Nascimento</label><input type="date" id="profile-dob" class="mt-1 block w-full p-3 bg-gray-100 rounded-lg border focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
            </main>
            <footer class="p-4 border-t bg-white">
                <button onclick="saveProfile()" class="w-full bg-blue-600 text-white p-4 rounded-lg font-semibold hover:bg-blue-700 transition-colors text-lg">Salvar Alterações</button>
            </footer>
        </div>

        <!-- ===== TELA: Adicionar/Editar Ferramenta ===== -->
        <div id="screen-add-tool" class="screen hidden flex-col h-full">
            <header class="p-4 border-b flex items-center">
                <button onclick="showScreen('screen-profile')" class="text-gray-600 mr-4" aria-label="Voltar para o perfil"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                <h1 id="add-edit-title" class="text-xl font-bold text-gray-800">Adicionar Ferramenta</h1>
            </header>
            <main class="flex-grow p-6 overflow-y-auto">
                <div class="mb-6"><label for="tool-photo" class="block text-sm font-medium text-gray-700 mb-2">Foto da Ferramenta</label><div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md"><div class="space-y-1 text-center"><svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg><p class="text-sm text-gray-600">Arraste e solte ou <button type="button" class="font-medium text-blue-600 hover:text-blue-500">clique para enviar</button></p><input id="tool-photo" name="tool-photo" type="file" class="sr-only"></div></div></div>
                <div class="mb-4"><label for="add-tool-name" class="block text-sm font-medium text-gray-700">Nome da Ferramenta</label><input type="text" id="add-tool-name" required placeholder="Ex: Chave de Fenda Phillips" class="mt-1 block w-full p-3 bg-gray-100 rounded-lg border focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
                <div class="mb-4"><label for="add-tool-description" class="block text-sm font-medium text-gray-700">Descrição (Opcional)</p><textarea id="add-tool-description" rows="4" placeholder="Adicione detalhes sobre a ferramenta..." class="mt-1 block w-full p-3 bg-gray-100 rounded-lg border focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea></div>
            </main>
            <footer class="p-4 border-t bg-white">
                <button id="save-tool-button" onclick="saveTool()" class="w-full bg-blue-600 text-white p-4 rounded-lg font-semibold hover:bg-blue-700 transition-colors text-lg">Salvar Ferramenta</button>
            </footer>
        </div>

    </div>

    <script>
        // PARTE 1: VARIÁVEIS GLOBAIS E DADOS FALSOS
        // Aqui guardamos informações que precisam ser acessadas em várias partes do código.
        
        let currentScreen = 'screen-login'; // Qual tela está aparecendo para o usuário
        let alertTimeout; // Usado para fazer a mensagem de alerta sumir depois de um tempo
        let editingToolId = null; // Guarda o ID da ferramenta que está sendo editada
        let toolIdToDelete = null; // Guarda o ID da ferramenta a ser excluída
        let toolIdToRequest = null; // Guarda o ID da ferramenta a ser solicitada
        let currentFilter = 'all'; // Qual filtro está ativo na tela principal ('todos', 'disponíveis', etc)
        let currentChatId = null; // Guarda o ID do chat que está aberto

        // --- SIMULAÇÃO DOS DADOS (BANCO DE DADOS FALSO) ---
        // Como não temos um banco de dados real, usamos essas listas para simular os dados do app.

        // Dados do perfil do usuário logado
        const myProfile = { name: 'Meu Nome', address: 'Asa Sul, Brasília', phone: '(61) 99999-8888', email: 'meuemail@email.com', dob: '1990-01-15' };
        // Lista de ferramentas de outros usuários
        const tools = [
            { id: 1, name: 'Furadeira de Impacto', owner: 'João V.', distance: '500m', status: 'Disponível', imageUrl: 'https://img.lojadomecanico.com.br/IMAGENS/21/221/18641/1653585349626.JPG', description: 'Furadeira potente para trabalhos pesados, acompanha maleta e brocas.' },
            { id: 2, name: 'Escada de Alumínio', owner: 'Maria S.', distance: '800m', status: 'Em uso', imageUrl: 'https://cdn.awsli.com.br/2500x2500/1131/1131299/produto/216638948/whatsapp-image-2023-05-11-at-16-22-00-cptl6dkm3t.jpeg', description: 'Escada de 5 degraus, leve e fácil de transportar. Ideal para pequenos reparos em casa.' },
            { id: 5, name: 'Parafusadeira', owner: 'Roberto F.', distance: '1.5km', status: 'Disponível', imageUrl: 'https://corebral.cdn.magazord.com.br/img/2022/05/produto/2855/parafusadeira-furadeira-de-impacto-12v-wesco-ws2547.png?ims=fit-in/800x800/filters:fill(white)', description: 'Parafusadeira sem fio com bateria de longa duração. Acompanha kit de bits.'},
            { id: 6, name: 'Cortador de Grama', owner: 'Fernanda L.', distance: '200m', status: 'Disponível', imageUrl: 'https://img.lojadomecanico.com.br/IMAGENS/33/782/121846/Cortador-de-Grama-a-Gasolina-B4T-6000SL--branco-903135751.JPG', description: 'Cortador a gasolina, potente para grandes áreas. Requer cuidado no manuseio.'},
            { id: 7, name: 'Soprador de Folhas', owner: 'Lucas M.', distance: '950m', status: 'Em uso', imageUrl: 'https://www.agrotama.com.br//upload/novo_produtos/sopradordefolhasgasolina26cc2t09hp_102061208.jpg', description: 'Soprador e aspirador de folhas. Facilita muito a limpeza de quintais.'},
            { id: 8, name: 'Lavadora de Alta Pressão', owner: 'Camila R.', distance: '1.1km', status: 'Disponível', imageUrl: 'https://karcher.vtexassets.com/arquivos/ids/160979/K2_Plus_NewStandard_01_19943720_19943730_RGB_96dpi_JPG.jpg?v=638744714509770000', description: 'Lavadora de alta pressão (WAP), ideal para limpeza de calçadas, carros e muros.'},
            { id: 9, name: 'Caixa de Ferramentas', owner: 'Pedro A.', distance: '400m', status: 'Disponível', imageUrl: 'https://encrypted-tbn0.gstatic.com/shopping?q=tbn:ANd9GcQIBrDKlo3TQZr5zo0kV49kAx6gtucjJ1ES0wURJQ_Jpnzfn7PgrkgdyYK30RH_Vh2uVwc3yxGXxVpcLLmLTW49pEbLB9yyX6vM2W3v5oQ&usqp=CAc', description: 'Caixa completa com martelo, alicates, chaves de fenda e chaves phillips de vários tamanhos.'}
        ];
        // Lista de ferramentas do usuário logado
        let myTools = [
             { id: 3, name: 'Serra Tico-Tico', owner: 'Meu Perfil', status: 'Disponível', description: 'Minha serra tico-tico para cortes precisos em madeira.', imageUrl: 'https://img.lojadomecanico.com.br/IMAGENS/21/224/151775/1706205635626.JPG' },
             { id: 4, name: 'Lixadeira Orbital', owner: 'Meu Perfil', status: 'Em uso', description: 'Lixadeira para acabamentos finos em madeira e outras superfícies.', imageUrl: 'https://img.lojadomecanico.com.br/IMAGENS/21/227/164110/lixadeira-orbital-180w-220v-1685398899755.JPG' }
        ];
        // Solicitações de empréstimo que o usuário recebeu
        let loanRequests = [ { id: 1, toolId: 3, requester: 'Carlos D.', status: 'pendente', startDate: '2024-07-15', endDate: '2024-07-16' } ];
        // Empréstimos que o usuário solicitou
        let myLoans = [];
        // Lista de conversas do chat
        let chats = [
             { id: 1, toolId: 3, otherUser: 'Carlos D.', messages: [ { sender: 'Carlos D.', text: 'Olá! Gostaria de pegar sua serra emprestada amanhã, pode ser?' }, { sender: 'Meu Perfil', text: 'Olá Carlos! Amanhã consigo depois das 14h, tudo bem?' }, { sender: 'Carlos D.', text: 'Perfeito! Combinado.' } ]}
        ];

        // PARTE 2: FUNÇÕES QUE CONTROLAM A INTERFACE E DESENHAM AS TELAS
        // Essas funções são responsáveis por mudar o que o usuário vê na tela.
        
        /**
         * FUNÇÃO: showLoader / hideLoader
         * O QUE FAZ: Mostra ou esconde a animação de carregamento.
         */
        function showLoader() { document.getElementById('loader-overlay').classList.remove('hidden'); }
        function hideLoader() { document.getElementById('loader-overlay').classList.add('hidden'); }

        /**
         * FUNÇÃO: showCustomAlert
         * O QUE FAZ: Mostra uma barrinha de mensagem (sucesso ou erro) no topo da tela.
         */
        function showCustomAlert(message, type = 'error') {
            const alertBox = document.getElementById('custom-alert');
            const alertMessage = document.getElementById('custom-alert-message');
            alertBox.classList.remove('bg-red-500', 'bg-green-500');
            alertBox.classList.add(type === 'error' ? 'bg-red-500' : 'bg-green-500');
            alertMessage.innerText = message;
            alertBox.classList.remove('hidden');
            clearTimeout(alertTimeout);
            alertTimeout = setTimeout(() => alertBox.classList.add('hidden'), 3000);
        }

        /**
         * FUNÇÃO: showScreen
         * O QUE FAZ: É o "navegador" do app. Esconde a tela atual e mostra a tela pedida.
         */
        function showScreen(screenId) {
            closeAllMenus();
            if (screenId === 'screen-profile') populateProfile();
            if (screenId === 'screen-edit-profile') populateEditProfile();
            if (screenId === 'screen-chat-list') renderChats();

            // Atualiza a barra de navegação para destacar o ícone correto
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('text-blue-600');
                btn.classList.add('text-gray-500');
                const isChatRelated = screenId.startsWith('screen-chat');
                if ((!isChatRelated && btn.dataset.screen === screenId) || (isChatRelated && btn.dataset.screen === 'screen-chat-list')) {
                    btn.classList.add('text-blue-600');
                    btn.classList.remove('text-gray-500');
                }
            });

            const activeScreen = document.getElementById(currentScreen);
            activeScreen?.classList.add('hidden');
            activeScreen?.classList.remove('flex');
            const nextScreen = document.getElementById(screenId);
            nextScreen?.classList.remove('hidden');
            nextScreen?.classList.add('flex');
            currentScreen = screenId;
        }
        
        /**
         * FUNÇÃO: renderTools
         * O QUE FAZ: Pega a lista de ferramentas, aplica filtros e as "desenha" na tela inicial.
         */
        function renderTools(searchTerm = '') {
            const toolListContainer = document.getElementById('tool-list');
            toolListContainer.innerHTML = '';
            
            // 1. Filtra por status (Todos, Disponíveis, Em uso)
            let filteredTools = [...tools];
            if (currentFilter === 'available') {
                filteredTools = filteredTools.filter(t => t.status === 'Disponível');
            } else if (currentFilter === 'in-use') {
                filteredTools = filteredTools.filter(t => t.status === 'Em uso');
            }

            // 2. Filtra pelo termo da busca
            if (searchTerm.trim() !== '') {
                const lowerCaseSearchTerm = searchTerm.toLowerCase();
                filteredTools = filteredTools.filter(tool => 
                    tool.name.toLowerCase().includes(lowerCaseSearchTerm)
                );
            }
            
            // 3. Renderiza o resultado
            if (filteredTools.length === 0) {
                 toolListContainer.innerHTML = `<div class="col-span-2 text-center text-gray-500 py-10 flex flex-col items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 10l.01.01" /></svg>
                    <p class="font-semibold">Nenhuma ferramenta encontrada</p>
                    <p class="text-sm">Tente uma busca ou filtro diferente.</p>
                </div>`;
                return;
            }

            filteredTools.forEach(tool => {
                toolListContainer.innerHTML += `<div onclick="showToolDetails(${tool.id})" class="bg-white border rounded-lg overflow-hidden cursor-pointer hover:shadow-lg transition-shadow"> <div class="w-full h-24 bg-gray-100 img-container"><img src="${tool.imageUrl}" alt="${tool.name}"></div> <div class="p-3"> <h3 class="font-semibold text-gray-800 truncate">${tool.name}</h3> <p class="text-sm text-gray-500">${tool.owner} - ${tool.distance}</p> </div> </div>`;
            });
        }
        
        /**
         * FUNÇÃO: renderMyTools
         * O QUE FAZ: Desenha as ferramentas que pertencem ao usuário na tela de perfil.
         */
        function renderMyTools() {
            const container = document.getElementById('tab-content-my-tools');
            container.innerHTML = ''; 
            if (myTools.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-500 py-10 flex flex-col items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" /></svg>
                    <p class="font-semibold">Nenhuma ferramenta cadastrada</p>
                    <p class="text-sm">Clique no botão '+' para adicionar sua primeira ferramenta.</p>
                </div>`;
                return;
            }
            myTools.forEach(tool => {
                const statusInfo = { 'Disponível': { c: 'green', t: 'Disponível' }, 'Indisponível': { c: 'gray', t: 'Indisponível' }, 'Em uso': { c: 'yellow', t: 'Em uso' } };
                const currentStatus = statusInfo[tool.status] || statusInfo['Indisponível'];
                const toggleText = tool.status === 'Disponível' ? 'Tornar Indisponível' : 'Tornar Disponível';
                container.innerHTML += `<div class="relative flex items-center justify-between p-3 mb-3 bg-white border rounded-lg"> <div class="flex items-center min-w-0"> <div class="w-12 h-12 rounded-md mr-4 flex-shrink-0 bg-gray-100 img-container"><img src="${tool.imageUrl}" alt="Imagem de ${tool.name}"/></div> <div class="min-w-0"> <h3 class="font-semibold text-gray-800 truncate">${tool.name}</h3> <span class="text-xs font-medium bg-${currentStatus.c}-100 text-${currentStatus.c}-700 px-2 py-1 rounded-full">${currentStatus.t}</span> </div> </div> <button onclick="toggleToolMenu(event, ${tool.id})" class="p-2 rounded-full text-gray-400 hover:bg-gray-100 hover:text-gray-600 flex-shrink-0" aria-label="Menu da ferramenta"> <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M6 10a2 2 0 11-4 0 2 2 0 014 0zM12 10a2 2 0 11-4 0 2 2 0 014 0zM16 12a2 2 0 100-4 2 2 0 000 4z" /></svg> </button> <div id="menu-${tool.id}" class="hidden absolute right-4 top-12 mt-2 w-48 bg-white rounded-md shadow-xl z-20"> <a href="javascript:void(0)" onclick="prepareEditTool(${tool.id})" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 menu-item">Editar</a> <a href="javascript:void(0)" onclick="toggleAvailability(${tool.id})" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 menu-item">${toggleText}</a> <a href="javascript:void(0)" onclick="openModal('delete', ${tool.id})" class="block px-4 py-2 text-sm text-red-600 hover:bg-gray-100 menu-item">Excluir</a> </div> </div>`;
            });
        }

        /**
         * FUNÇÃO: renderRequests
         * O QUE FAZ: Mostra as solicitações de empréstimo que outros usuários fizeram para você.
         */
        function renderRequests() {
            const container = document.getElementById('tab-content-my-requests');
            const badges = [document.getElementById('requests-notification-badge'), document.getElementById('profile-notification-badge'), document.getElementById('profile-notification-badge-chat')];
            container.innerHTML = '';
            const pending = loanRequests.filter(r => r.status === 'pendente');
            
            if (pending.length > 0) badges.forEach(b => b?.classList.remove('hidden'));
            else {
                badges.forEach(b => b?.classList.add('hidden'));
                container.innerHTML = `<div class="text-center text-gray-500 py-10 flex flex-col items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>
                    <p class="font-semibold">Nenhuma nova solicitação</p>
                    <p class="text-sm">Você será notificado aqui quando receber uma.</p>
                </div>`;
                return;
            }

            pending.forEach(req => {
                const tool = myTools.find(t => t.id === req.toolId);
                if (!tool) return;
                container.innerHTML += `<div class="p-3 mb-3 bg-white border rounded-lg"> <div class="flex items-start"> <div class="w-12 h-12 rounded-md mr-4 flex-shrink-0 bg-gray-100 img-container"><img src="${tool.imageUrl}" alt="${tool.name}"/></div> <div> <p class="text-sm"><span class="font-bold">${req.requester}</span> quer pegar emprestado sua <span class="font-bold">${tool.name}</span>.</p> <p class="text-xs text-gray-500 mt-1">Datas sugeridas: ${req.startDate} até ${req.endDate}</p> </div> </div> <div class="flex justify-end gap-2 mt-3"> <button onclick="handleRequest(${req.id}, 'decline')" class="px-4 py-1 text-sm bg-gray-200 text-gray-800 rounded-lg font-semibold">Recusar</button> <button onclick="handleRequest(${req.id}, 'accept')" class="px-4 py-1 text-sm bg-blue-600 text-white rounded-lg font-semibold">Aceitar</button> </div> </div>`;
            });
        }

        /**
         * FUNÇÃO: renderMyLoans
         * O QUE FAZ: Mostra as ferramentas que você pediu emprestado.
         */
        function renderMyLoans() {
            const container = document.getElementById('tab-content-my-loans');
            container.innerHTML = '';
            if (myLoans.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-500 py-10 flex flex-col items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
                    <p class="font-semibold">Nenhum empréstimo solicitado</p>
                    <p class="text-sm">Suas solicitações aparecerão aqui.</p>
                </div>`;
                return;
            }
            myLoans.forEach(loan => {
                const tool = tools.find(t => t.id === loan.toolId);
                if (!tool) return;
                const statusInfo = { 'pendente': {c:'yellow', t:'Pendente'}, 'aceito': {c:'green', t:'Aceito'}, 'recusado': {c:'red', t:'Recusado'} };
                const current = statusInfo[loan.status];
                container.innerHTML += `<div class="flex items-center justify-between p-3 mb-3 bg-white border rounded-lg"> <div class="flex items-center min-w-0"> <div class="w-12 h-12 rounded-md mr-4 flex-shrink-0 bg-gray-100 img-container"><img src="${tool.imageUrl}" alt="${tool.name}"/></div> <div class="min-w-0"> <h3 class="font-semibold text-gray-800 truncate">${tool.name}</h3> <p class="text-sm text-gray-500">de ${tool.owner}</p> </div> </div> <span class="text-xs font-medium bg-${current.c}-100 text-${current.c}-700 px-2 py-1 rounded-full flex-shrink-0">${current.t}</span> </div>`;
            });
        }
        
        /**
         * FUNÇÃO: renderChats
         * O QUE FAZ: Desenha a lista de todas as suas conversas na tela de chat.
         */
        function renderChats() {
            const container = document.getElementById('chat-list-container');
            container.innerHTML = '';
             if (chats.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-500 p-10 flex flex-col items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>
                    <p class="font-semibold">Nenhuma conversa ativa</p>
                    <p class="text-sm">Após um empréstimo ser solicitado, o chat aparecerá aqui.</p>
                </div>`;
                return;
            }
            chats.forEach(chat => {
                const tool = [...tools, ...myTools].find(t => t.id === chat.toolId);
                if(!tool) return;
                const lastMessage = chat.messages[chat.messages.length - 1]?.text || 'Clique para negociar...';
                container.innerHTML += `<div onclick="openChatConversation(${chat.id})" class="flex items-center p-4 border-b hover:bg-gray-50 cursor-pointer"> <img src="https://placehold.co/48x48/e2e8f0/334155?text=${chat.otherUser.charAt(0)}" class="w-12 h-12 rounded-full mr-4" alt="Avatar de ${chat.otherUser}"/> <div class="min-w-0"> <h3 class="font-semibold">${chat.otherUser}</h3> <p class="text-sm text-gray-600 truncate">(${tool.name}) ${lastMessage}</p> </div> </div>`;
            });
        }
        
        /**
         * FUNÇÃO: openChatConversation
         * O QUE FAZ: Abre uma conversa específica quando o usuário clica nela.
         */
        function openChatConversation(chatId) {
            currentChatId = chatId;
            const chat = chats.find(c => c.id === chatId);
            if (!chat) return;
            const tool = [...tools, ...myTools].find(t => t.id === chat.toolId);
            if (!tool) return;

            document.getElementById('conversation-user-avatar').src = `https://placehold.co/40x40/e2e8f0/334155?text=${chat.otherUser.charAt(0)}`;
            document.getElementById('conversation-user-avatar').alt = `Avatar de ${chat.otherUser}`;
            document.getElementById('conversation-user-name').innerText = chat.otherUser;
            document.getElementById('conversation-tool-context').innerText = `Sobre: ${tool.name}`;
            document.getElementById('send-message-button').onclick = () => sendMessage(chatId);

            renderConversationMessages(chat);
            showScreen('screen-chat-conversation');
        }

        /**
         * FUNÇÃO: renderConversationMessages
         * O QUE FAZ: Desenha as mensagens (balõezinhos) dentro da tela de uma conversa.
         */
        function renderConversationMessages(chat) {
            const container = document.getElementById('chat-conversation-container');
            container.innerHTML = '';
            chat.messages.forEach(msg => {
                const messageClass = msg.sender === 'Meu Perfil'
                    ? 'bg-blue-600 text-white rounded-l-lg rounded-br-lg'
                    : 'bg-gray-200 text-gray-800 rounded-r-lg rounded-bl-lg';
                const wrapperClass = msg.sender === 'Meu Perfil' ? 'justify-end' : 'justify-start';
                container.innerHTML += `<div class="flex items-start ${wrapperClass}"><div class="p-3 max-w-xs ${messageClass}">${msg.text}</div></div>`;
            });
            container.scrollTop = container.scrollHeight;
        }

        /**
         * FUNÇÃO: sendMessage
         * O QUE FAZ: Pega o texto do campo de mensagem e o adiciona na conversa.
         */
        function sendMessage(chatId) {
            const input = document.getElementById('chat-message-input');
            const text = input.value.trim();
            if (!text) return;
            const chat = chats.find(c => c.id === chatId);
            if (!chat) return;
            chat.messages.push({ sender: 'Meu Perfil', text });
            input.value = '';
            renderConversationMessages(chat);
        }

        /**
         * FUNÇÃO: showToolDetails
         * O QUE FAZ: Mostra a tela com todos os detalhes de uma ferramenta específica.
         */
        function showToolDetails(toolId) {
            const tool = [...tools, ...myTools].find(t => t.id === toolId);
            if (!tool) return;
            toolIdToRequest = toolId; // Guarda o ID da ferramenta para a tela de solicitação
            document.getElementById('details-image').src = tool.imageUrl;
            document.getElementById('details-image').alt = `Imagem de ${tool.name}`;
            document.getElementById('details-title').innerText = tool.name;
            document.getElementById('details-owner').innerText = `Disponibilizado por ${tool.owner}`;
            document.getElementById('details-description').innerText = tool.description || 'Nenhuma descrição fornecida.';
            const statusBox = document.getElementById('details-status-box');
            const actionButton = document.getElementById('details-action-button');

            if (tool.status === 'Disponível') {
                statusBox.innerHTML = `<div class="bg-green-100 text-green-700 p-2 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg></div><div><h3 class="font-semibold text-gray-800">Disponível</h3><p class="text-sm text-gray-500">Pode ser retirada hoje</p></div>`;
                actionButton.innerText = 'Solicitar Empréstimo';
                actionButton.className = 'w-full text-white p-4 rounded-lg font-semibold transition-colors text-lg bg-blue-600 hover:bg-blue-700';
                actionButton.onclick = () => prepareLoanRequest();
            } else { 
                statusBox.innerHTML = `<div class="bg-yellow-100 text-yellow-700 p-2 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div><div><h3 class="font-semibold text-gray-800">Em uso</h3><p class="text-sm text-gray-500">Indisponível no momento</p></div>`;
                actionButton.innerText = 'Agendar';
                actionButton.className = 'w-full text-white p-4 rounded-lg font-semibold transition-colors text-lg bg-orange-500 hover:bg-orange-600';
                actionButton.onclick = () => openModal('schedule');
            }
            showScreen('screen-details');
        }

        /**
         * FUNÇÃO: prepareLoanRequest
         * O QUE FAZ: Prepara a tela para o usuário preencher as datas e solicitar uma ferramenta.
         */
        function prepareLoanRequest() {
            const tool = [...tools, ...myTools].find(t => t.id === toolIdToRequest);
            if (!tool) return;
            document.getElementById('request-tool-image').src = tool.imageUrl;
            document.getElementById('request-tool-image').alt = `Imagem de ${tool.name}`;
            document.getElementById('request-tool-name').innerText = tool.name;
            document.getElementById('request-tool-owner').innerText = `de ${tool.owner}`;
            document.getElementById('request-back-button').onclick = () => showToolDetails(toolIdToRequest);
            document.getElementById('request-submit-button').onclick = () => submitLoanRequest();
            document.getElementById('request-start-date').valueAsDate = new Date();
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('request-end-date').valueAsDate = tomorrow;
            showScreen('screen-request-loan');
        }
        
        /**
         * FUNÇÃO: submitLoanRequest
         * O QUE FAZ: Valida e "envia" a solicitação de empréstimo.
         */
        function submitLoanRequest() {
            const startDateInput = document.getElementById('request-start-date');
            const endDateInput = document.getElementById('request-end-date');
            const startDate = new Date(startDateInput.value);
            const endDate = new Date(endDateInput.value);

            // Validação
            let isValid = true;
            if (!startDateInput.value || !endDateInput.value || endDate <= startDate) {
                showCustomAlert('A data de devolução deve ser após a data de retirada.');
                endDateInput.classList.add('border-red-500');
                isValid = false;
            } else {
                 endDateInput.classList.remove('border-red-500');
            }

            if (!isValid) return;

            const tool = tools.find(t => t.id === toolIdToRequest);
            if (!tool) return;
            
            showLoader();
            setTimeout(() => {
                myLoans.unshift({ id: Date.now(), toolId: tool.id, status: 'pendente' });
                const newChat = {
                    id: Date.now(), toolId: tool.id, otherUser: tool.owner,
                    messages: [ { sender: 'Meu Perfil', text: `Olá! Tenho interesse na sua ${tool.name}. Podemos combinar as datas?` } ]
                };
                chats.unshift(newChat);
                
                hideLoader();
                showCustomAlert('Solicitação enviada!', 'success');
                showScreen('screen-chat-list');
            }, 1000); // Simula atraso da rede
        }

        /**
         * FUNÇÃO: handleRequest
         * O QUE FAZ: Processa a ação de aceitar ou recusar uma solicitação de empréstimo.
         */
        function handleRequest(requestId, action) {
            const request = loanRequests.find(r => r.id === requestId);
            if (!request) return;
            request.status = action === 'accept' ? 'aceito' : 'recusado'; // Atualiza status
            const tool = myTools.find(t => t.id === request.toolId);
            if (action === 'accept') {
                if(tool) tool.status = 'Em uso';
            }
            renderMyTools();
            renderRequests();
        }

        /**
         * FUNÇÃO: showProfileTab
         * O QUE FAZ: Controla qual aba está sendo mostrada na tela de perfil.
         */
        function showProfileTab(tabId) {
            document.querySelectorAll('[id^="tab-"]').forEach(tab => {
                tab.classList.remove('border-blue-600', 'text-blue-600');
                tab.classList.add('border-transparent', 'text-gray-500');
            });
            document.querySelectorAll('[id^="tab-content-"]').forEach(content => content.classList.add('hidden'));
            document.getElementById(`tab-${tabId}`).classList.add('border-blue-600', 'text-blue-600');
            document.getElementById(`tab-content-${tabId}`).classList.remove('hidden');
        }
        
        /**
         * FUNÇÃO: saveTool
         * O QUE FAZ: Salva uma nova ferramenta ou as alterações de uma existente.
         */
        function saveTool() {
            const nameInput = document.getElementById('add-tool-name');
            const name = nameInput.value.trim();
            const description = document.getElementById('add-tool-description').value.trim();
            
            if (!name) { 
                showCustomAlert('O nome da ferramenta é obrigatório.'); 
                nameInput.classList.add('border-red-500');
                return; 
            }
            nameInput.classList.remove('border-red-500');

            showLoader();
            setTimeout(() => {
                if (editingToolId) { // Se estava editando...
                    const tool = myTools.find(t => t.id === editingToolId);
                    if (tool) { tool.name = name; tool.description = description; }
                } else { // Se era uma ferramenta nova...
                    myTools.unshift({ id: Date.now(), name, owner: 'Meu Perfil', status: 'Disponível', description, imageUrl: `https://placehold.co/50x50/e2e8f0/334155?text=${encodeURIComponent(name.split(' ')[0])}`});
                }
                hideLoader();
                showCustomAlert('Ferramenta salva com sucesso!', 'success');
                renderMyTools();
                showScreen('screen-profile');
                showProfileTab('my-tools');
            }, 1000);
        }
        
        /**
         * FUNÇÃO: prepareAddTool
         * O QUE FAZ: Limpa e prepara o formulário para adicionar uma nova ferramenta.
         */
        function prepareAddTool() {
            editingToolId = null;
            document.getElementById('add-edit-title').innerText = 'Adicionar Ferramenta';
            document.getElementById('save-tool-button').innerText = 'Salvar Ferramenta';
            document.getElementById('add-tool-name').value = '';
            document.getElementById('add-tool-description').value = '';
            showScreen('screen-add-tool');
        }

        /**
         * FUNÇÃO: prepareEditTool
         * O QUE FAZ: Preenche o formulário com os dados de uma ferramenta existente para edição.
         */
        function prepareEditTool(toolId) {
            const tool = myTools.find(t => t.id === toolId);
            if (!tool) return;
            editingToolId = toolId;
            document.getElementById('add-edit-title').innerText = 'Editar Ferramenta';
            document.getElementById('save-tool-button').innerText = 'Salvar Alterações';
            document.getElementById('add-tool-name').value = tool.name;
            document.getElementById('add-tool-description').value = tool.description;
            showScreen('screen-add-tool');
        }

        /**
         * FUNÇÃO: toggleAvailability
         * O QUE FAZ: Muda o status de uma ferramenta entre 'Disponível' e 'Indisponível'.
         */
        function toggleAvailability(toolId) {
            const tool = myTools.find(t => t.id === toolId);
            if (tool && tool.status !== 'Em uso') {
                tool.status = tool.status === 'Disponível' ? 'Indisponível' : 'Disponível';
                renderMyTools();
            } else if (tool.status === 'Em uso') {
                 showCustomAlert('Não é possível alterar o status de uma ferramenta em uso.');
            }
            closeAllMenus();
        }

        /**
         * FUNÇÃO: openModal / closeModal
         * O QUE FAZ: Abre e fecha as janelinhas de confirmação (pop-ups).
         */
        function openModal(type, toolId) {
            document.getElementById('modal-overlay').classList.remove('hidden');
            document.getElementById('modal-overlay').classList.add('flex');
            if (type === 'delete') {
                toolIdToDelete = toolId;
                document.getElementById('confirm-delete-modal').classList.remove('hidden');
            } else if (type === 'schedule') {
                document.getElementById('confirm-schedule-modal').classList.remove('hidden');
            }
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.add('hidden');
            document.getElementById('modal-overlay').classList.remove('flex');
            document.getElementById('confirm-delete-modal').classList.add('hidden');
            document.getElementById('confirm-schedule-modal').classList.add('hidden');
            toolIdToDelete = null;
        }

        /**
         * FUNÇÃO: confirmDelete
         * O QUE FAZ: Exclui a ferramenta após a confirmação do usuário.
         */
        function confirmDelete() {
            if (toolIdToDelete !== null) {
                myTools = myTools.filter(t => t.id !== toolIdToDelete);
                renderMyTools();
                renderTools();
            }
            closeModal();
        }
        
        /**
         * FUNÇÃO: confirmSchedule
         * O QUE FAZ: Confirma o agendamento de uma ferramenta.
         */
        function confirmSchedule() {
            showCustomAlert('Agendamento confirmado!', 'success');
            closeModal();
        }

        /**
         * FUNÇÃO: toggleToolMenu / closeAllMenus
         * O QUE FAZ: Mostra e esconde o menu de 3 pontinhos (editar, excluir...) em cada ferramenta.
         */
        function toggleToolMenu(event, toolId) {
            event.stopPropagation();
            const targetMenu = document.getElementById(`menu-${toolId}`);
            const isHidden = targetMenu.classList.contains('hidden');
            closeAllMenus();
            if (isHidden) targetMenu.classList.remove('hidden');
        }
        
        function closeAllMenus() {
            document.querySelectorAll('[id^="menu-"]').forEach(menu => menu.classList.add('hidden'));
        }

        /**
         * FUNÇÃO: applyFilter
         * O QUE FAZ: Filtra as ferramentas na tela inicial (Todos, Disponíveis, Em uso).
         */
        function applyFilter(filterType) {
            currentFilter = filterType;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('filter-btn-active');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            const activeButton = document.getElementById(`filter-${filterType}`);
            activeButton.classList.add('filter-btn-active');
            activeButton.classList.remove('bg-gray-200', 'text-gray-700');
            const searchTerm = document.getElementById('search-input').value;
            renderTools(searchTerm);
        }

        /**
         * FUNÇÃO: populateProfile / populateEditProfile
         * O QUE FAZ: Preenche as telas de perfil com os dados do usuário.
         */
        function populateProfile() {
            document.getElementById('profile-name-header').innerText = myProfile.name;
            renderMyTools();
            renderRequests();
            renderMyLoans();
        }

        function populateEditProfile() {
            document.getElementById('profile-name').value = myProfile.name;
            document.getElementById('profile-address').value = myProfile.address;
            document.getElementById('profile-phone').value = myProfile.phone;
            document.getElementById('profile-email').value = myProfile.email;
            document.getElementById('profile-dob').value = myProfile.dob;
        }

        /**
         * FUNÇÃO: saveProfile
         * O QUE FAZ: Salva as informações do perfil que foram alteradas.
         */
        function saveProfile() {
            showLoader();
            setTimeout(() => {
                myProfile.name = document.getElementById('profile-name').value;
                myProfile.address = document.getElementById('profile-address').value;
                myProfile.phone = document.getElementById('profile-phone').value;
                myProfile.email = document.getElementById('profile-email').value;
                myProfile.dob = document.getElementById('profile-dob').value;
                hideLoader();
                showCustomAlert('Perfil salvo com sucesso!', 'success');
                showScreen('screen-profile');
            }, 1000);
        }

        /**
         * FUNÇÃO: registerUser
         * O QUE FAZ: Valida e simula o cadastro de um novo usuário.
         */
        function registerUser(event) {
            event.preventDefault(); // Impede o envio do formulário
            const pass = document.getElementById('register-password');
            const confirmPass = document.getElementById('register-confirm-password');
            
            if (pass.value !== confirmPass.value) {
                showCustomAlert('As senhas não coincidem.');
                pass.classList.add('border-red-500');
                confirmPass.classList.add('border-red-500');
                return;
            }
            pass.classList.remove('border-red-500');
            confirmPass.classList.remove('border-red-500');

            showLoader();
            setTimeout(() => {
                hideLoader();
                showCustomAlert('Cadastro realizado com sucesso!', 'success');
                showScreen('screen-dashboard');
            }, 1000);
        }
        
        // PARTE 3: PONTO DE PARTIDA DO CÓDIGO
        // Este código é executado assim que a página HTML termina de carregar.
        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('confirm-delete-button').onclick = confirmDelete;
            
            const searchInput = document.getElementById('search-input');
            searchInput.addEventListener('input', (e) => {
                renderTools(e.target.value);
            });

            populateProfile();
            renderTools();
            document.body.addEventListener('click', closeAllMenus, true);
        });
    </script>

</body>
</html>
